 ASP.NET Core 中的中间件控制应用程序如何响应 HTTP 请求。 还可以控制应用程序在出现错误时的外观，是验证和授权用户执行特定操作的关键部分。
中间件是ASP.NET Core的核心组件，MVC框架、响应缓存、身份验证、CORS、Swagger等都是内置中间件。
### 中间件的流转过程
![image.png](https://upload-images.jianshu.io/upload_images/29491970-a96563b052e4810f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 中间件的三个概念（Map 、Use  、Run）

Map用来定义一个管道可以处理哪些请求，Use和Run用来定义管道。
一个管道由若干个Use和一个Run组成，每个Use引入一个中间件，Run是用来执行最终的核心应用逻辑。

   ![image.png](https://upload-images.jianshu.io/upload_images/29491970-4ae421ae9ad224da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### .NET 6中常用的中间件：
Routing Middleware：用于处理URL路由，将请求路由到适当的处理程序或控制器。

Authentication Middleware：用于处理身份验证和授权，验证用户的身份并授权访问受限资源。

Authorization Middleware：用于检查用户是否有权限访问请求的资源。

Static Files Middleware：用于提供静态文件（如HTML、CSS、JavaScript、图像等）给客户端。

Exception Handling Middleware：用于捕获和处理应用程序中的异常，返回适当的错误响应。

Logging Middleware：用于记录应用程序的日志，可以将日志信息写入到文件、数据库或其他日志存储。

CORS Middleware：用于处理跨域资源共享（CORS）请求，允许客户端从不同的域名访问服务器资源。

Compression Middleware：用于对响应进行压缩，以减小传输大小，提高网络性能。

Session Middleware：用于在应用程序中启用会话状态，跟踪用户的状态和数据。

Health Checks Middleware：用于检查应用程序的健康状态，例如数据库连接、服务可用性等。
### 简单定义一个中间件
![image.png](https://upload-images.jianshu.io/upload_images/29491970-2faab13517e08d01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ps:为了演示每个中间件都输出类容，在实际中在Run里面输出内容，避免HTTP报文混乱。

### 中间件类
这个类需要有一个构造方法，构造方法至少要有一个RequestDekegate类型的参数，这个参数用来指向下一个中间件。
这个类还需要定义一个名字为Invoke或InvokeAsync的方法，方法至少有一个 HttpContect类型的参数，方法返回值必须是Task类型。
![image.png](https://upload-images.jianshu.io/upload_images/29491970-83d35cbcb11659e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

使用中间件
```
app.Map("/test", async (pipBuilder) =>
{
          pipBuilder.UseMiddleware<TestMiddleware>()
    
    
});
```
### 使用用户验证中间件
1.在Startup.cs文件中，找到ConfigureServices方法。

2.在ConfigureServices方法中，配置身份验证服务。这可能涉及到配置身份验证方案、添加身份验证提供程序、配置身份验证选项等。
 ```
public void ConfigureServices(IServiceCollection services)
{
      services.AddAuthentication() .AddJwtBearer(options =>
        {
            // 配置 JWT Bearer 认证选项
            // ...
        });

}
```
3.在Configure方法中，使用UseAuthentication方法来启用身份验证中间件
```
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // 其他配置...

    app.UseAuthentication();

    // 其他配置...
}
```
4.在需要进行身份验证的请求处理中，使用[Authorize]属性来标记需要进行身份验证的端点或控制器。
 ```
[ApiController]
[Route("api/[controller]")]
[Authorize]
public class MyController : ControllerBase
{
    // ...
}
```
